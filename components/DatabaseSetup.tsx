
import React from 'react';
import { useLocalization } from '../hooks/useLocalization';
import { X, Copy, Database, Image as ImageIcon, Users, AlertTriangle, ShieldAlert, CheckCircle, Unlock, Bell, ShoppingBag, ListPlus, UserCheck, Megaphone, ShieldCheck, Layers, Wrench } from 'lucide-react';

const CodeBlock: React.FC<{ title: string; code: string }> = ({ title, code }) => {
  const { t } = useLocalization();
  const [copied, setCopied] = React.useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="mb-6">
      <h4 className="text-lg font-semibold text-dark dark:text-light mb-2">{title}</h4>
      <div className="relative bg-gray-200 dark:bg-gray-900 rounded-lg p-4 font-mono text-sm text-gray-800 dark:text-gray-300 overflow-x-auto">
        <button
          onClick={handleCopy}
          className="absolute top-2 right-2 p-1.5 bg-gray-300 dark:bg-gray-700 rounded-md hover:bg-gray-400 dark:hover:bg-gray-600"
          aria-label={t('copyCode')}
        >
          <Copy size={16} />
        </button>
        <pre><code>{code}</code></pre>
        {copied && <span className="absolute bottom-2 right-2 text-xs text-green-600 dark:text-green-400">{t('copied')}</span>}
      </div>
    </div>
  );
};


const DatabaseSetup: React.FC<{ isOpen: boolean; onClose: () => void; }> = ({ isOpen, onClose }) => {
  const { t } = useLocalization();
  
  const emergencyFixSQL = `-- 1. FIX CLIENTS & PROVIDERS
ALTER TABLE public.clients ADD COLUMN IF NOT EXISTS bio text;
ALTER TABLE public.clients ADD COLUMN IF NOT EXISTS profile_image_url text;

ALTER TABLE public.providers ADD COLUMN IF NOT EXISTS bio text;
ALTER TABLE public.providers ADD COLUMN IF NOT EXISTS profile_image_url text;
ALTER TABLE public.providers ADD COLUMN IF NOT EXISTS latitude float;
ALTER TABLE public.providers ADD COLUMN IF NOT EXISTS longitude float;

-- 2. SYSTEM ADS
CREATE TABLE IF NOT EXISTS public.system_announcements (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    title text,
    message text,
    image_url text,
    is_active boolean DEFAULT true,
    images text[]
);
ALTER TABLE public.system_announcements ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access SystemAds" ON public.system_announcements;
CREATE POLICY "Public Access SystemAds" ON public.system_announcements FOR ALL USING (true) WITH CHECK (true);

-- 3. STORE PRODUCTS
CREATE TABLE IF NOT EXISTS public.products (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    name text NOT NULL,
    description text,
    price numeric NOT NULL,
    image_url text,
    category text DEFAULT 'General',
    images text[],
    sizes text[]
);
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Products" ON public.products;
CREATE POLICY "Public Access Products" ON public.products FOR ALL USING (true) WITH CHECK (true);

-- 4. ORDERS
CREATE TABLE IF NOT EXISTS public.orders (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    user_id bigint NOT NULL,
    user_type text NOT NULL,
    total_amount numeric NOT NULL,
    status text DEFAULT 'pending',
    items jsonb,
    customer_details jsonb
);
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Orders" ON public.orders;
CREATE POLICY "Public Access Orders" ON public.orders FOR ALL USING (true) WITH CHECK (true);

-- 5. JOB BOARD
CREATE TABLE IF NOT EXISTS public.job_posts (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    user_id bigint,
    user_name text,
    title text,
    description text,
    skills text[],
    contact_phone text,
    likes bigint DEFAULT 0,
    category text,
    post_type text DEFAULT 'EMPLOYER',
    image_url text
);
ALTER TABLE public.job_posts ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Jobs" ON public.job_posts;
CREATE POLICY "Public Access Jobs" ON public.job_posts FOR ALL USING (true) WITH CHECK (true);

-- 6. COMMENTS
CREATE TABLE IF NOT EXISTS public.job_comments (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now(),
    job_id bigint REFERENCES public.job_posts(id) ON DELETE CASCADE,
    user_name text,
    comment text
);
ALTER TABLE public.job_comments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access JobComments" ON public.job_comments;
CREATE POLICY "Public Access JobComments" ON public.job_comments FOR ALL USING (true) WITH CHECK (true);

-- 7. STORAGE
INSERT INTO storage.buckets (id, name, public) VALUES ('product-images', 'product-images', true) ON CONFLICT (id) DO UPDATE SET public = true;
INSERT INTO storage.buckets (id, name, public) VALUES ('announcement-images', 'announcement-images', true) ON CONFLICT (id) DO UPDATE SET public = true;
INSERT INTO storage.buckets (id, name, public) VALUES ('profiles', 'profiles', true) ON CONFLICT (id) DO UPDATE SET public = true;

DROP POLICY IF EXISTS "Public Storage" ON storage.objects;
CREATE POLICY "Public Storage" ON storage.objects FOR ALL USING (true) WITH CHECK (true);

SELECT 'Database Successfully Updated' as status;`;

  if (!isOpen) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/60 z-40" onClick={onClose}></div>
      <div className="fixed top-0 right-0 rtl:left-0 rtl:right-auto h-full w-full max-w-2xl bg-gray-100 dark:bg-gray-800 shadow-xl z-50 transform transition-transform duration-300 ease-in-out" style={{ transform: isOpen ? 'translateX(0)' : 'translateX(100%)' }}>
        <div className="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-gray-100 dark:bg-gray-800 z-10">
          <h3 className="text-xl font-bold text-dark dark:text-light flex items-center gap-2">
            <Database /> {t('databaseSetupTitle')}
          </h3>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            <X size={24} className="text-dark dark:text-light" />
          </button>
        </div>
        <div className="p-6 h-[calc(100vh-65px)] overflow-y-auto">
          
          {/* EMERGENCY FIX */}
          <div className="mb-8 p-4 border-l-4 border-red-600 bg-red-50 dark:bg-red-900/20 rounded-r-lg shadow-lg animate-fade-in">
             <h3 className="text-xl font-bold text-red-700 dark:text-red-400 flex items-center gap-2 mb-4">
                <Wrench /> üö® ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ•ÿµŸÑÿßÿ≠Ÿä ÿßŸÑÿ¥ÿßŸÖŸÑ
             </h3>
             <p className="mb-2 text-sm text-gray-600 dark:text-gray-400">
               Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ Ÿäÿ∂ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÜÿßŸÇÿµÿ© (ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ÿå ÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖÿå ÿßŸÑŸÖÿ™ÿ¨ÿ±). ÿßŸÜÿ≥ÿÆŸá Ÿàÿ∂ÿπŸá ŸÅŸä Supabase.
             </p>
             <CodeBlock title="Full Database Fix" code={emergencyFixSQL.trim()} />
          </div>

        </div>
      </div>
    </>
  );
};

export default DatabaseSetup;
