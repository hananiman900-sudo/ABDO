import React from 'react';
import { useLocalization } from '../hooks/useLocalization';
import { X, Copy, Database, ShieldCheck } from 'lucide-react';

const CodeBlock: React.FC<{ title: string; code: string }> = ({ title, code }) => {
  const { t } = useLocalization();
  const [copied, setCopied] = React.useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="mb-6">
      <h4 className="text-lg font-semibold text-dark dark:text-light mb-2">{title}</h4>
      <div className="relative bg-gray-200 dark:bg-gray-900 rounded-lg p-4 font-mono text-sm text-gray-800 dark:text-gray-300 overflow-x-auto">
        <button
          onClick={handleCopy}
          className="absolute top-2 right-2 p-1.5 bg-gray-300 dark:bg-gray-700 rounded-md hover:bg-gray-400 dark:hover:bg-gray-600"
          aria-label={t('copyCode')}
        >
          <Copy size={16} />
        </button>
        <pre><code>{code}</code></pre>
        {copied && <span className="absolute bottom-2 right-2 text-xs text-green-600 dark:text-green-400">{t('copied')}</span>}
      </div>
    </div>
  );
};

const DatabaseSetup: React.FC<{ isOpen: boolean; onClose: () => void; }> = ({ isOpen, onClose }) => {
  const { t } = useLocalization();
  
  // SQL FIX FOR V37: CHAT HISTORY OPTIMIZATION (PERSISTENCE)
  const v37SQL = `-- V37: Optimize Chat History & Booking Persistence
-- This ensures queries for chat history are fast even with many stored bookings
CREATE INDEX IF NOT EXISTS idx_chat_history_user_provider ON public.chat_history(user_id, provider_id);

-- Optional: Ensure text column can store large JSON strings
ALTER TABLE public.chat_history ALTER COLUMN text TYPE text;

NOTIFY pgrst, 'reload config';`;

  // SQL FIX FOR V36: FIX AFFILIATE PERMISSIONS
  const v36SQL = `-- V36: Fix Permissions for Admin to Update Affiliate Balances
-- Allow anyone (Admin) to update affiliate_sales status
DROP POLICY IF EXISTS "Public Read Sales" ON public.affiliate_sales;
DROP POLICY IF EXISTS "Public Insert Sales" ON public.affiliate_sales;
CREATE POLICY "Public Manage Sales" ON public.affiliate_sales FOR ALL USING (true) WITH CHECK (true);

-- Allow anyone (Admin) to update affiliate_partners earnings
DROP POLICY IF EXISTS "Public Read Partners" ON public.affiliate_partners;
DROP POLICY IF EXISTS "Public Insert Partners" ON public.affiliate_partners;
DROP POLICY IF EXISTS "Public Update Partners" ON public.affiliate_partners;
CREATE POLICY "Public Manage Partners" ON public.affiliate_partners FOR ALL USING (true) WITH CHECK (true);

NOTIFY pgrst, 'reload config';`;

  // SQL FIX FOR V35: PRICE WITH PROMO CODE
  const v35SQL = `-- V35: Store Discount Price Logic
ALTER TABLE public.products ADD COLUMN IF NOT EXISTS discount_price numeric DEFAULT 0;
-- Ensure previous columns exist
ALTER TABLE public.products ADD COLUMN IF NOT EXISTS affiliate_commission numeric DEFAULT 0;
ALTER TABLE public.products ADD COLUMN IF NOT EXISTS is_featured boolean DEFAULT false;

NOTIFY pgrst, 'reload config';`;

  // SQL FIX FOR V34: ADVANCED STORE & AFFILIATE
  const v34SQL = `-- V34: Advanced Affiliate & Store
-- 1. Add specific commission & featured status to products
ALTER TABLE public.products ADD COLUMN IF NOT EXISTS affiliate_commission numeric DEFAULT 0;
ALTER TABLE public.products ADD COLUMN IF NOT EXISTS is_featured boolean DEFAULT false;

-- 2. Add status to sales (to track pending deliveries)
ALTER TABLE public.affiliate_sales ADD COLUMN IF NOT EXISTS status text DEFAULT 'pending';

-- 3. Create Withdrawal Requests Table
CREATE TABLE IF NOT EXISTS public.withdrawal_requests (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  partner_id bigint REFERENCES public.affiliate_partners(id),
  amount numeric,
  status text DEFAULT 'pending',
  created_at timestamp with time zone DEFAULT now()
);

-- 4. RLS for Withdrawals
ALTER TABLE public.withdrawal_requests ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Manage Withdrawals" ON public.withdrawal_requests FOR ALL USING (true) WITH CHECK (true);

NOTIFY pgrst, 'reload config';`;

  // SQL FIX FOR V33: AFFILIATE APPROVAL
  const v33SQL = `-- V33: Affiliate Approval System
ALTER TABLE public.affiliate_partners ADD COLUMN IF NOT EXISTS status text DEFAULT 'pending';
NOTIFY pgrst, 'reload config';`;

  // SQL FIX FOR V32: AFFILIATE SYSTEM
  const v32SQL = `-- V32: Affiliate System
-- 1. Create Partners Table
CREATE TABLE IF NOT EXISTS public.affiliate_partners (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id bigint REFERENCES public.clients(id) ON DELETE CASCADE UNIQUE,
  promo_code text UNIQUE NOT NULL,
  commission_rate numeric DEFAULT 0.05, -- 5% commission for partner
  discount_rate numeric DEFAULT 0.10, -- 10% discount for buyer
  total_earnings numeric DEFAULT 0,
  status text DEFAULT 'pending',
  created_at timestamp with time zone DEFAULT now()
);

-- 2. Create Sales Table
CREATE TABLE IF NOT EXISTS public.affiliate_sales (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  partner_id bigint REFERENCES public.affiliate_partners(id),
  order_id bigint REFERENCES public.orders(id),
  amount numeric,
  commission numeric,
  status text DEFAULT 'pending',
  created_at timestamp with time zone DEFAULT now()
);

-- 3. RLS
ALTER TABLE public.affiliate_partners ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.affiliate_sales ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public Read Partners" ON public.affiliate_partners FOR SELECT USING (true);
CREATE POLICY "Public Insert Partners" ON public.affiliate_partners FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Update Partners" ON public.affiliate_partners FOR UPDATE USING (true);

CREATE POLICY "Public Read Sales" ON public.affiliate_sales FOR SELECT USING (true);
CREATE POLICY "Public Insert Sales" ON public.affiliate_sales FOR INSERT WITH CHECK (true);

NOTIFY pgrst, 'reload config';`;

  const completeSQL = `${v32SQL}
${v33SQL}
${v34SQL}
${v35SQL}
${v36SQL}
${v37SQL}`;

  if (!isOpen) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/60 z-40" onClick={onClose}></div>
      <div className="fixed top-0 right-0 rtl:left-0 rtl:right-auto h-full w-full max-w-2xl bg-gray-100 dark:bg-gray-800 shadow-xl z-50 transform transition-transform duration-300 ease-in-out" style={{ transform: isOpen ? 'translateX(0)' : 'translateX(100%)' }}>
        <div className="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-gray-100 dark:bg-gray-800 z-10">
          <h3 className="text-xl font-bold text-dark dark:text-light flex items-center gap-2">
            <Database /> {t('databaseSetupTitle')}
          </h3>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            <X size={24} className="text-dark dark:text-light" />
          </button>
        </div>
        <div className="p-6 h-[calc(100vh-65px)] overflow-y-auto">
          
           <div className="mb-8 p-4 border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/20 rounded-r-lg shadow-lg animate-fade-in">
             <div className="flex items-center gap-2 mb-2">
                <ShieldCheck className="text-blue-600 dark:text-blue-400" size={24}/>
                <h3 className="text-xl font-bold text-blue-600 dark:text-blue-400">
                   System Updates (V32-V37)
                </h3>
             </div>
             <p className="mb-3 text-sm text-gray-700 dark:text-gray-300 font-bold">
                Run these commands to enable Affiliate System, Discount Prices, and Chat History Optimization.
             </p>
             <CodeBlock title="Complete SQL Script (V32-V37)" code={completeSQL.trim()} />
          </div>

          <p className="mb-6 text-gray-700 dark:text-gray-300">{t('databaseSetupDesc')}</p>
        </div>
      </div>
    </>
  );
};

export default DatabaseSetup;